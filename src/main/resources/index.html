<html>
<head>
<!--
<link rel="stylesheet" href="/static/css/jquery.contextmenu.css">
<link rel="stylesheet" href="/static/css/treeview/jquery.treeview.css" />     
<link rel="stylesheet" href="/static/css/treeview/screen.css" />
-->
<style>
  #prover {
    background-color:#FFFFFF;
    height: 90%;
    width: 100%;
    text-align: center;
    vertical-align: center;
    font-size: 20px;
  }
  #footer {
    text-align: center;
    height: 5%;
    width: 100%;
  }
  #welcome {
    
    text-align: center;
//    font-size: 32px;
    font-size: 20px;
    width: 100%;
    height: 5%;
  }

  #errorMessage {
    text-align: left;
    font-size: 12px;
    width: 100%;
    color: #FF0000;
  }

  #sequent {
    border: 2px solid;
    border-radius: 25px;
    margin-top: 20px;
    min-height:200px;
  }
  #proof {
    border: 2px solid;
    border-radius: 25px;
    margin-top: 20px;
    height: 80%;
    overflow:scroll;
  }
  .hl {background: transparent; }
  .hlhover { background:#00aaaa; }
</style>
<!-- extrnal libraries -->
<script src="/static/js/external/jquery.js" type="text/javascript"></script>
<script src="/static/js/external/mktree.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/mktree.css" type="text/css">
<!--
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="/static/js/jquery.treeview.js" type="text/javascript"></script>
<script src="/static/js/jquery.contextmenu.js"></script>
-->

<!-- the "core" UI classes -->
<script src="/static/js/ui.js" type="text/javascript"></script>
<!--
<script src="/static/js/tactics.js" type="text/javascript"></script>
-->
<script src="/static/js/api.js" type="text/javascript"></script>
<!--
<script src="/static/js/expression.js" type="text/javascript"></script>
-->
<script src="/static/js/event_handler.js" type="text/javascript"></script>

<!-- Tree views -->
<!--
<script src="/static/js/tree/tree.js" type="text/javascript"></script>
<script src="/static/js/tree/simple_view.js" type="text/javascript"></script>
<script src="/static/js/tree/key_tree_view.js" type="text/javascript"></script>
-->

<script>

</script>
<script>
  var userid = window.prompt("Enter user id", "0");
  ApiClient.createNewUser(userid)

  var ClientState = {
    uid: userid,
    proofid: -1
  }

  //Handles an event from the file chooser.
  function handleChooserEvent(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files;
    var file = files[0];
    loadFile(file);
  }

  //Loads a window.File object using the FileReader.
  function loadFile(file) {
    var fr = new FileReader();
    fr.onerror = function(e) { alert("Could not even open your file: " + e.getMessage()); }

    fr.onload = function(e) {
      ApiClient.createNewProof(userid, e.target.result,
      function(resp) {
		  ClientState.proofid = resp.proofid;
		  update(root = resp.proofTree.model);
		});
      /*ApiClient.runTactic(userid, 0, resp.proofid, function (resp) { alert(JSON.stringify(resp)); }); }); */
      //setInterval(function() { ApiClient.getUpdates(userid, problemid); }, 500);
    }

    fr.readAsText(file);
  }

  //Initialize the file selector and main event loop when the page is loaded.
  window.onload = function() {
    if(!(window.File && window.FileReader && window.FileList && window.Blob)) {
      alert("The KeYmaera4 web front-end requires the HTML 5 file API. " +
            "It appears your browser does not support this API ." +
            "Please update to the latest version of a standards-compliant browser.");
    }

    //Add an event listener for the file box.
    var drop_zone = document.getElementById('drop_zone');
    drop_zone.addEventListener('dragover', function(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy';
      }, false);
    drop_zone.addEventListener('drop', function(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        var files = evt.dataTransfer.files;
        var file = files[0];
        loadFile(file);
        }, false);
    files.addEventListener('change', function(evt) {
        var files = evt.target.files;
        var file = files[0];
        loadFile(file);
        }, false);
    //Create main event loop. Ugh we should be doing something better.
    setInterval(function() { ApiClient.getUpdates(userid); }, 500);
  }
</script>
</head>
<body>
<div class="welcome" id="welcome">
  KeYmaera4
</div>

<div class="prover" id="prover">
  <span id="provercontents">
    <div class="drop_zone" id="drop_zone">
     <!-- Drag and Drop a .key into the grey area to begin.
      <br/>
      <br/>-->
      <input type="file" id="files" name="files[]" multiple />
        <div class="row">
            <div class="large-9 columns">
                <div style="width: 100%; overflow: hidden;">
                    <div id="proof" class="proof" style="width: 300px; float: left;">
                    </div>
                    <div id="sequent" class="sequent" style="margin-left: 320px;">
                    </div>
                </div>
                <script>

var svg = $("#proof").append("<ul class=\"mktree\" style=\"text-align: left\" id=\"prooful\"></ul>").find("ul")/*.append("svg")
			.attr("width", width + margin.left + margin.right)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")")*/;
var seq = $("#sequent").append("<div></div>").find("div");

function span(id, cont) {
    return "<span xmlns=\"http://www.w3.org/1999/xhtml\" onmouseover=\"$(event.target).addClass('hlhover');\" onmouseout=\"$(event.target).removeClass('hlhover');\" class='hl' id='" + id + "'>" + cont + "</span>"
}

function handle(json) {
  var items = [];
  if(json.name == "not") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          items.push(span(json.id, "&not;" + left));
      }
  } else if(json.name == "and") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &#8743; " + right));
      }
  } else if(json.name == "or") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &#8744; " + right));
      }
  } else if(json.name == "imply") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " â†’ " + right));
      }
  } else if(json.name == "equiv") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &#8596 " + right));
      }
  } else if(json.name == "lt") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &lt; " + right));
      }
  } else if(json.name == "leq") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &leq; " + right));
      }
  } else if(json.name == "equals") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " = " + right));
      }
  } else if(json.name == "notEquals") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &neq; " + right));
      }
  } else if(json.name == "geq") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &geq; " + right));
      }
  } else if(json.name == "gt") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &gt; " + right));
      }
  } else if(json.name == "neg") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          items.push(span(json.id, "-" + left));
      }
  } else if(json.name == "add") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " + " + right));
      }
  } else if(json.name == "subtract") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " - " + right));
      }
  } else if(json.name == "multiply") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &middot; " + right));
      }
  } else if(json.name == "divide") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " / " + right));
      }
   } else if(json.name == "exp") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " <sup>" + right + "</sup>"));
      }
  } else if(json.name == "boxmodality") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, "[" + left + "] " + right));
      }
  } else if(json.name == "Assign") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " := " + right));
      }
  } else if(json.name == "NDetAssign") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          items.push(span(json.id, left + ":= *"));
      }
  } else if(json.name == "Test") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          items.push(span(json.id, "?" + left));
      }
  } else if(json.name == "Loop") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          items.push(span(json.id, "{" + left + "}<sup>*</sup>" ));
      }
  } else if(json.name == "Sequence") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + "; " + right));
      }
  } else if(json.name == "Choice") {
      var c = json.children;
      if($.isArray(c)) {
          var left = handle(c[0]);
          var right = handle(c[1]);
          items.push(span(json.id, left + " &#8746; " + right));
      }
  } else {
      var chil = "";
      if(json.hasOwnProperty("children")) {
        var strs = [];
        var c = json.children;
        for(var i = 0; i < c.length; i++) {
            strs.push(handle(c[i]));
        }
        chil = "(" + strs.join(", ") + ")";
      }
      items.push(span(json.id, json.name + chil));
  }
  return items.join("");
}

var selected = "";

function update(source) {
	svg.html(translateNode(root));
	convertTrees();
	expandTree('prooful');
	if(selected.length == 0) {
	    selected = root._id;
	}
	$("#span" + selected).click();
    //colorSelected(selected);
}

function translateFormula(nId, f) {
	 return "<span id=\"" + f.id + "\"onClick=\"ApiClient.runTactic(ClientState.uid, 1, ClientState.proofid, '" + nId + "', '" + f.id + "', function (resp) { });\">" + handle(f.formula) + "</span>";
}

function translateSequent(nId, s) {
	var res = "";
	s.ante.forEach(function(f) {
		res = res + translateFormula(nId, f) + "<br>";
	});
	res = res + "<span onClick=\"ApiClient.runGlobalTactic(ClientState.uid, 0, ClientState.proofid, '" + nId + "', function (resp) { alert(JSON.stringify(resp)); });\"> &#8866; </span><br>";
	s.succ.forEach(function(f) {
		res = res + translateFormula(nId, f) + "<br>";
	});
	return res;
}


function colorSelected(id) {
    if(selected.length > 0) {
        $("#span" + selected).css("background-color", "white");
    }
    $("#span" + id).css("background-color", "red");
    selected = id;
}

function showSequent(id, sequent) {
    seq.html(translateSequent(id, JSON.parse(sequent.replace(/'/g, "\""))));
    colorSelected(id);
}

function translateNode(node) {
	var str = "<li id=\"" + node.id + "\" _id=\"" + node._id + "\"> <span id=\"span" + node._id + "\" onclick=\"showSequent('" + node._id + "', '" + JSON.stringify(node.sequent).replace(/\"/g, "\\'") + "');\"> &#8866; </span>";
	if(node.children.length > 0) {
	    str = str + "<ul>";
        node.children.forEach(function(c) {
            str = str + translateRule(c);
        });
	    str = str + "</ul>";
    }
	return str + "</li>";
}

function translateRule(rule) {
	var res = "<li id=\"" + rule.id + "\">"
	if(rule.children.length == 0) {
	    res = res + "<span style=\"color:green\">" + rule.rule + "</span>";
	} else {
	    res = res + rule.rule;
    }
	rule.children.forEach(function(c) {
		res = res + translateNode(c);
	});
	return res + "</li>";
}

// Toggle children on click.
function click(d) {
  alert(JSON.stringify(d));
  ApiClient.runTactic(ClientState.uid, 0, ClientState.proofid, d.nodeId, function (resp) { alert(JSON.stringify(resp)); });
  /*if (d.children) {
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  update(d);*/
}
      	</script>
            </div>
        </div>
    </div>
  </span>
</div>

</span>

<!-- now poorly named... -->
<span class="footer">
  <center>
    <span id="status" style="background-color: #555500; color: #FFFFFF">Disconnected</span>
  </center>
  <span id="errors">
    <div>Error Messages (see console for detailed output): </div>
  </span>
</span>
</body>
</html>

